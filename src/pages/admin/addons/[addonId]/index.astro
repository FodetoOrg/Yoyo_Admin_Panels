---
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import AddonForm from "./_components/AddonForm";
import { UserRole } from "@/lib/utils/auth";
import { serverApiService, type ApiResponse } from "@/lib/utils/api";
import { CONSTANTS, ROUTES } from "@/lib/utils/constants";

const { addonId } = Astro.params;
const url = Astro.url;
const hotelId = url.searchParams.get('hotelId');

// Check if user has permission (middleware already authenticated)
const currentUser = Astro.locals.user;
console.log('currentUser  addons',currentUser)
if (!currentUser || (currentUser.role !== UserRole.SUPER_ADMIN && currentUser.role !== UserRole.HOTEL_ADMIN)) {
  return Astro.redirect('/admin/dashboard');
}

// Parse addon ID to get hotel and addon IDs
let addonData: any = null;


if (addonId && addonId !== "new") {
 
  const addOnResponse : ApiResponse<any> = await serverApiService.get(
    `/api/v1/addons/hotels/${currentUser.hotelId}/addons/${addonId}`,
    Astro.cookies.get(CONSTANTS.ACCESS_TOKEN_KEY)?.value || "",
    Astro.cookies
  );

  console.log('addOnResponse ',addOnResponse)
  if(addOnResponse.success){
   addonData = addOnResponse.data.addon
  }
}

// Fetch hotels for dropdown (only for super admin)
let hotels: any[] = [];
if (currentUser.role === UserRole.SUPER_ADMIN) {
  const hotelsResponse: ApiResponse<any> = await serverApiService.get(
    ROUTES.GET_ALL_HOTELS_ROUTE,
    Astro.cookies.get(CONSTANTS.ACCESS_TOKEN_KEY)?.value || "",
    Astro.cookies
  );
  hotels = hotelsResponse.success 
    ? hotelsResponse.data.map((hotel: any) => ({ id: hotel.id, name: hotel.name }))
    : [];
}
---

<DashboardLayout title="Addon Management">
  <AddonForm 
    addonData={addonData} 
    hotels={hotels} 
    currentUser={currentUser}
    client:load 

  />
</DashboardLayout>