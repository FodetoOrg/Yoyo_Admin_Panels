---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import Screen from "./_components/screen";
import { apiService, serverApiService, type ApiResponse } from "../../../lib/utils/api";
import { CONSTANTS, ROUTES } from "../../../lib/utils/constants";
import { UserRole } from "@/lib/utils/auth";

// Check if user has permission (middleware already authenticated)
const currentUser = Astro.locals.user;
if (!currentUser || currentUser.role !== UserRole.SUPER_ADMIN) {
  return Astro.redirect('/admin/dashboard');
}

// Get cityId from query parameters if provided
const cityId = Astro.url.searchParams.get("cityId");
const refresh = Astro.url.searchParams.get("refresh");

// Build API URL with cityId if provided
let apiUrl = ROUTES.GET_ALL_HOTELS_ROUTE;
if (cityId && !refresh) {
  apiUrl += `?cityId=${cityId}`;
}

const res:ApiResponse<any> = await serverApiService.get(apiUrl, Astro.cookies.get(CONSTANTS.ACCESS_TOKEN_KEY)?.value || "", Astro.cookies);

let hotels:any[] = [];

if(res.success){
    hotels = res.data;
}

console.log('hotels ',hotels)
---

<DashboardLayout title="Hotels">
    <Screen hotels={hotels} client:load writeAccess={true} cityId={cityId} />
</DashboardLayout>